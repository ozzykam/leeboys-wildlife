<div class="scheduler-container max-w-7xl mx-auto p-6">
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Schedule Service</h1>
    <p class="text-gray-600">Schedule new wildlife removal services for customers</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Scheduling Form -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h2 class="text-lg font-semibold mb-4">Service Details</h2>
      
      <form [formGroup]="scheduleForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Service Request Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Link to Service Request *
          </label>
          <select 
            formControlName="serviceRequestId"
            (change)="onServiceRequestSelected()"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Select existing service request...</option>
            <option 
              *ngFor="let request of serviceRequests$ | async" 
              [value]="request.id">
              {{ request.customerName }} - {{ request.problemType }} ({{ formatTimestamp(request.createdAt) }})
            </option>
          </select>
        </div>

        <!-- Customer Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Customer *
          </label>
          <select 
            formControlName="customerId"
            (change)="onCustomerSelected()"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-red-300]="scheduleForm.get('customerId')?.invalid && scheduleForm.get('customerId')?.touched">
            <option value="">Select customer...</option>
            <option 
              *ngFor="let customer of availableCustomers$ | async" 
              [value]="customer.uid">
              {{ customer.displayName }} ({{ customer.email }})
            </option>
          </select>
        </div>

        <!-- Service Types Selection (Checkboxes) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Service Types *
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3"
               [class.border]="scheduleForm.get('selectedServices')?.invalid && scheduleForm.get('selectedServices')?.touched"
               [class.border-red-300]="scheduleForm.get('selectedServices')?.invalid && scheduleForm.get('selectedServices')?.touched"
               [class.rounded-md]="scheduleForm.get('selectedServices')?.invalid && scheduleForm.get('selectedServices')?.touched"
               [class.p-2]="scheduleForm.get('selectedServices')?.invalid && scheduleForm.get('selectedServices')?.touched">
            <label 
              *ngFor="let type of serviceTypes" 
              class="flex items-center space-x-3 p-2 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer transition-colors"
              [class.border-blue-500]="isServiceSelected(type.value)"
              [class.bg-blue-50]="isServiceSelected(type.value)">
              <input 
                type="checkbox" 
                [checked]="isServiceSelected(type.value)"
                (change)="onServiceToggle(type.value)"
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-gray-700">{{ type.label }}</span>
            </label>
          </div>
          <div *ngIf="scheduleForm.get('selectedServices')?.invalid && scheduleForm.get('selectedServices')?.touched" 
               class="text-sm text-red-600 mt-1">
            Please select at least one service type.
          </div>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Description *
          </label>
          <textarea 
            formControlName="description"
            rows="3"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-red-300]="scheduleForm.get('description')?.invalid && scheduleForm.get('description')?.touched"
            placeholder="Describe the service to be performed..."></textarea>
        </div>

        <!-- Duration Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Duration (estimated) *
          </label>
          <select 
            formControlName="duration"
            (change)="onDurationChange()"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-red-300]="scheduleForm.get('duration')?.invalid && scheduleForm.get('duration')?.touched">
            <option 
              *ngFor="let option of durationOptions" 
              [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <!-- Date Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Service Date *
          </label>
          <input 
            type="date" 
            formControlName="scheduledDate"
            (change)="onDateInputChange($event)"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-red-300]="scheduleForm.get('scheduledDate')?.invalid && scheduleForm.get('scheduledDate')?.touched"
            [min]="minDate">
        </div>

        <!-- Time Slot Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Available Time Slots *
          </label>
          
          <!-- Available time slots -->
          <div *ngIf="availableTimeSlots.length > 0" 
               class="grid grid-cols-2 sm:grid-cols-3 gap-2">
            <button 
              *ngFor="let slot of availableTimeSlots"
              type="button"
              (click)="onTimeSlotSelect(slot)"
              class="px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
              [class.border-blue-500]="isTimeSlotSelected(slot)"
              [class.bg-blue-50]="isTimeSlotSelected(slot)"
              [class.text-blue-700]="isTimeSlotSelected(slot)"
              [class.font-medium]="isTimeSlotSelected(slot)">
              {{ formatTime(slot) }}
            </button>
          </div>
          
          <!-- No slots available message -->
          <div *ngIf="availableTimeSlots.length === 0 && selectedDate" 
               class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
            <div class="flex items-start">
              <mat-icon class="text-yellow-600 mr-2 mt-0.5">warning</mat-icon>
              <div>
                <p class="text-sm font-medium text-yellow-800">No Available Time Slots</p>
                <p class="text-sm text-yellow-700 mt-1">{{ getNoSlotsMessage() }}</p>
              </div>
            </div>
          </div>
          
          <!-- Date not selected message -->
          <div *ngIf="!selectedDate" 
               class="p-4 bg-gray-50 border border-gray-200 rounded-md text-center">
            <mat-icon class="text-gray-400 mb-2">event</mat-icon>
            <p class="text-sm text-gray-600">Please select a date to see available time slots</p>
          </div>
          
          <!-- Validation error -->
          <div *ngIf="scheduleForm.get('timeSlot')?.invalid && scheduleForm.get('timeSlot')?.touched" 
               class="text-sm text-red-600 mt-1">
            Please select a time slot.
          </div>
        </div>

        <!-- Priority -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Priority *
          </label>
          <select 
            formControlName="priority"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option 
              *ngFor="let priority of priorities" 
              [value]="priority.value">
              {{ priority.label }}
            </option>
          </select>
        </div>

        <!-- Estimated Cost -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Estimated Cost
          </label>
          <input 
            type="number" 
            formControlName="estimatedCost"
            min="0"
            step="0.01"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="0.00">
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Notes
          </label>
          <textarea 
            formControlName="notes"
            rows="2"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Additional notes or special instructions..."></textarea>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end space-x-4">
          <button 
            type="button"
            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
            Cancel
          </button>
          <button 
            type="submit"
            [disabled]="scheduleForm.invalid || isSubmitting"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            <span *ngIf="isSubmitting">Scheduling...</span>
            <span *ngIf="!isSubmitting">Schedule Service</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Calendar View -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
      <h2 class="text-lg font-semibold mb-4">Calendar</h2>
      <app-calendar
        [events]="(calendarEvents$ | async) ?? []"
        [selectedDate]="selectedDate"
        (dateSelected)="onDateSelected($event)">
      </app-calendar>
    </div>
  </div>
</div>